version: 1.10.0
pack_type: rust_audit_general
engine: rsqt
response_schema: '--- REQUIRED OUTPUT FORMAT ---

  MANDATORY FIRST LINES (must be the first two lines of your response; copy exactly):

  VERDICT=TRUE_POSITIVE|FALSE_POSITIVE|INDETERMINATE

  CITATIONS=path:line(-line), path:line(-line), ...


  After those two lines, write the answer body.


  Hard bans:

  - Do NOT output Markdown section headers like "Analysis:" or "CITATIONS:".

  - Do NOT invent line numbers or file paths. Only cite tokens that appear in the evidence (including artifact anchors like *.json:1).

  - Do NOT include VERDICT or CITATIONS anywhere else in the body.


  Policy:

  - If a claim cannot be proven from extracted evidence, set VERDICT=INDETERMINATE and say "INSUFFICIENT EVIDENCE" + list what is missing.

  - Prefer deterministic extraction evidence; do NOT speculate.

  '
defaults:
  chat_top_k: 12
  max_tokens: 1200
  temperature: 0.0
questions:
- id: R_HEALTH_1
  title: Codebase Health Grade
  category: health
  top_k: 6
  advice_mode: llm
  question: 'Provide an executive summary of codebase health.


    The evidence shows a composite health analysis with:

    - Overall grade (A+ to F) and score

    - Safety score (unsafe, FFI, transmute, raw pointers)

    - Reliability score (panics, unwraps, expects)

    - Coverage score (test coverage percentage)

    - API surface metrics


    Summarize the grade, highlight any areas below 80%, and provide

    1-2 actionable recommendations for improvement.

    '
  preflight:
  - name: health_summary
    cmd:
    - health
    - --format
    - json
  expected_verdict: TRUE_POSITIVE
- id: R_META_1
  title: Workspace Proof Files Present
  category: meta
  top_k: 8
  advice_mode: llm
  question: 'Inventory proof files present in the indexed corpus.

    You MUST paste the exact file paths from evidence. Do NOT write placeholders like "(list all paths found)".


    List:

    - All Cargo.toml file paths (paste each path from evidence, e.g. crates/engine/Cargo.toml)

    - Cargo.lock path (if present in evidence)

    - rust-toolchain.toml path (if present in evidence)

    '
  preflight:
  - name: cargo_toml_files
    cmd:
    - query
    - --file
    - Cargo.toml
    - --include-all-files
    - --columns
    - file_path
    - total_lines
    - --limit
    - '20'
    - --format
    - json
  - name: cargo_lock
    cmd:
    - query
    - --file
    - Cargo.lock
    - --include-all-files
    - --columns
    - file_path
    - total_lines
    - --limit
    - '5'
    - --format
    - json
  - name: toolchain
    cmd:
    - query
    - --file
    - rust-toolchain
    - --include-all-files
    - --columns
    - file_path
    - total_lines
    - --limit
    - '5'
    - --format
    - json
  expected_verdict: TRUE_POSITIVE
- id: R_META_2
  title: Entity, Module, and Impl Distribution
  category: meta
  top_k: 6
  advice_mode: llm
  question: 'Show the distribution of:

    1. Entity kinds (fn/struct/trait/impl/enum/macro)

    2. Module types (lib/bin/test/module)

    3. Impl blocks per file (complexity indicator)

    Identify whether this looks like a library crate, binary crate, or workspace.

    Note files with high impl counts as potential complexity hotspots.

    '
  preflight:
  - name: entity_stats
    cmd:
    - entities
    - --stats
    - --format
    - json
  - name: module_distribution
    cmd:
    - modules
    - --format
    - json
  - name: impl_distribution
    cmd:
    - impls
    - --format
    - json
  expected_verdict: TRUE_POSITIVE
- id: R_API_1
  title: Public Surface Counts by File
  category: api_coverage
  top_k: 8
  advice_mode: llm
  question: 'Which Rust files have the largest public API surface?

    The evidence shows files sorted by API surface size with counts:

    - pub_fn_count, pub_struct_count, pub_trait_count

    Provide top 10 file paths with their counts and summarize total API surface.

    '
  preflight:
  - name: api_surface
    cmd:
    - api-surface
    - --format
    - json
  expected_verdict: TRUE_POSITIVE
- id: R_API_2
  title: Top Public Items (Heuristic)
  category: api_coverage
  top_k: 15
  advice_mode: llm
  question: 'List examples of public API items (heuristic scan). Provide:

    - up to 10 pub fn signatures

    - up to 10 pub struct declarations

    - up to 10 pub trait declarations

    - up to 10 pub enum declarations

    Use the extracted signature/line_text present in evidence; do NOT require full source files.

    Include file:line citations.

    Even if you think evidence is insufficient, you MUST still output VERDICT and CITATIONS per pack schema.

    '
  preflight:
  - name: fn_entities
    cmd:
    - entities
    - --kind
    - fn
    - --limit
    - '30'
    - --format
    - json
  - name: struct_entities
    cmd:
    - entities
    - --kind
    - struct
    - --limit
    - '30'
    - --format
    - json
  - name: trait_entities
    cmd:
    - entities
    - --kind
    - trait
    - --limit
    - '20'
    - --format
    - json
  - name: enum_entities
    cmd:
    - entities
    - --kind
    - enum
    - --limit
    - '20'
    - --format
    - json
  - name: pub_fn_hits
    cmd:
    - search
    - 'pub fn '
    - --limit
    - '50'
    - --format
    - json
  - name: pub_struct_hits
    cmd:
    - search
    - 'pub struct '
    - --limit
    - '50'
    - --format
    - json
  - name: pub_trait_hits
    cmd:
    - search
    - 'pub trait '
    - --limit
    - '30'
    - --format
    - json
  - name: pub_enum_hits
    cmd:
    - search
    - 'pub enum '
    - --limit
    - '30'
    - --format
    - json
  expected_verdict: TRUE_POSITIVE
- id: R_API_3
  title: Public Re-exports (pub use)
  category: api_coverage
  top_k: 10
  advice_mode: llm
  question: "Identify public re-exports via `pub use`.\nQuote each `pub use` statement from the evidence below, one per line, with its file:line citation. Include at least the first 20 results.\nOutput format (one per line):\n  pub use crate::module::{Type1, Type2};  // file.rs:NN\n\nDo NOT just say \"listed above\" - you MUST repeat each pub use line in your answer.\n"
  preflight:
  - name: pub_use_hits
    cmd:
    - search
    - 'pub use '
    - --limit
    - '80'
    - --format
    - json
    transform:
      render: lines
  expected_verdict: TRUE_POSITIVE
- id: R_RISK_1
  title: Risk Hotspots Analysis
  category: safety
  top_k: 8
  advice_mode: llm
  question: 'Identify the highest-risk production files based on weighted factors.


    The evidence shows files ranked by risk score combining:

    - unwrap/panic usage

    - unsafe code presence

    - transmute usage

    - test coverage gaps

    - public API exposure


    For the top 5 hotspots:

    1. List file path and risk score

    2. Identify the primary risk factors

    3. Recommend specific mitigation (add tests, reduce unwraps, etc.)


    If no hotspots found (all scores near 0), state: "No significant risk hotspots detected."

    '
  preflight:
  - name: risk_hotspots
    cmd:
    - risk-hotspots
    - --format
    - json
    - --limit
    - '10'
  expected_verdict: TRUE_POSITIVE
- id: R_SAFE_1
  title: Unsafe Code Inventory
  category: safety
  top_k: 8
  advice_mode: llm
  question: 'Inventory unsafe usage:

    - list files containing unsafe blocks/functions

    - report block counts and whether SAFETY comments exist (if indicated by evidence).

    If no unsafe usage, explicitly say: "No unsafe blocks detected by rsqt unsafe".

    '
  preflight:
  - name: unsafe_blocks
    cmd:
    - unsafe
    - --format
    - json
  - name: safety_comment_hits
    cmd:
    - search
    - 'SAFETY:'
    - --limit
    - '80'
    - --format
    - json
  expected_verdict: TRUE_POSITIVE
- id: R_SAFE_2
  title: FFI / ABI Surface
  category: safety
  top_k: 8
  advice_mode: llm
  question: 'Inventory FFI/ABI surface:

    - extern "C"

    - #[no_mangle]

    - #[repr(C)]

    - static mut (if present)

    If count=0 or no results, explicitly state: "No FFI/ABI surface detected."

    If FFI exists, summarize the risk and what invariants must hold.

    '
  preflight:
  - name: ffi_surface
    cmd:
    - ffi
    - --format
    - json
  - name: static_mut_hits
    cmd:
    - search
    - static mut
    - --limit
    - '40'
    - --format
    - json
  expected_verdict: TRUE_POSITIVE
- id: R_SAFE_3
  title: Runtime Failure Surface (Production unwrap/expect)
  category: safety
  top_k: 12
  advice_mode: llm
  question: "List production `.unwrap(` and `.expect(` call sites (not tests).\n\nVALID OUTCOMES:\n1. If unwrap_hits and expect_hits are EMPTY after test-file filtering:\n   State: \"No production unwrap/expect detected. All unwrap/expect calls are in test code.\"\n   This is a VALID \"clean\" outcome (not NOT FOUND).\n2. If hits exist, cite each with file:line and classify.\n\nFOR EACH CALL SITE (if any):\n- Cite as file_path:line from evidence\n- Include the code snippet from evidence\n- Classify as INVARIANT / RECOVERABLE / PANIC_OK\n\nNOTE: Empty evidence after filtering = \"no issues\" = good outcome.\n"
  preflight:
  - name: unwrap_hits
    cmd:
    - search
    - .unwrap(
    - --limit
    - '120'
    - --format
    - json
    transform:
      exclude_test_files: true
      exclude_comments: true
      require_contains: .unwrap(
      max_items: 30
      render: lines
  - name: expect_hits
    cmd:
    - search
    - .expect(
    - --limit
    - '120'
    - --format
    - json
    transform:
      exclude_test_files: true
      exclude_comments: true
      require_contains: .expect(
      max_items: 30
      render: lines
  expected_verdict: TRUE_POSITIVE
- id: R_SAFE_4
  title: Panic / TODO Surface (Production Only)
  category: safety
  top_k: 10
  advice_mode: llm
  question: 'Identify potential intentional panics / unfinished code in PRODUCTION code (not tests):

    - panic!( calls

    - todo!( and unimplemented!( macros


    The evidence shows panic counts per file. Filter out test files and assess:

    - If only test files have panics: "No production panic risk detected."

    - If production files have panics: list them with risk assessment.

    '
  preflight:
  - name: panic_files
    cmd:
    - panics
    - --format
    - json
  - name: todo_hits
    cmd:
    - search
    - todo!(
    - --limit
    - '60'
    - --format
    - json
    transform:
      exclude_test_files: true
      max_items: 20
      render: lines
  - name: unimplemented_hits
    cmd:
    - search
    - unimplemented!(
    - --limit
    - '60'
    - --format
    - json
    transform:
      exclude_test_files: true
      max_items: 20
      render: lines
  expected_verdict: TRUE_POSITIVE
- id: R_SAFE_5
  title: Transmute and Raw Pointer Surface
  category: safety
  top_k: 8
  advice_mode: llm
  question: 'Inventory dangerous memory operations:

    - transmute calls (mem::transmute, transmute_copy)

    - raw pointer usage (*const T, *mut T)

    If count=0 for both, state: "No transmute or raw pointer usage detected."

    If found, list files and assess risk level (HIGH/MEDIUM/LOW).

    '
  preflight:
  - name: transmute_files
    cmd:
    - transmute
    - --format
    - json
  - name: raw_ptr_files
    cmd:
    - raw-ptrs
    - --format
    - json
  expected_verdict: TRUE_POSITIVE
- id: R_SAFE_6
  title: Detailed Unsafe Breakdown
  category: safety
  top_k: 8
  advice_mode: llm
  question: 'Provide detailed breakdown of unsafe code by category:

    - unsafe fn declarations (functions declared as unsafe)

    - unsafe impl blocks (impl blocks for unsafe traits)

    - unsafe trait declarations (traits requiring unsafe impl)

    - unsafe blocks within safe functions

    Summarize which category dominates and assess overall safety posture.

    If all counts are zero, state: "No unsafe code detected in any category."

    '
  preflight:
  - name: unsafe_breakdown
    cmd:
    - query
    - --columns
    - file_path
    - unsafe_fn_count
    - unsafe_impl_count
    - unsafe_trait_count
    - unsafe_block_count
    - --limit
    - '100'
    - --format
    - json
  - name: unsafe_fn_hits
    cmd:
    - search
    - 'unsafe fn '
    - --limit
    - '40'
    - --format
    - json
  - name: unsafe_impl_hits
    cmd:
    - search
    - 'unsafe impl '
    - --limit
    - '40'
    - --format
    - json
  - name: unsafe_trait_hits
    cmd:
    - search
    - 'unsafe trait '
    - --limit
    - '20'
    - --format
    - json
  expected_verdict: TRUE_POSITIVE
- id: R_TEST_1
  title: Test Coverage and Exposure Risk
  category: testing
  top_k: 10
  advice_mode: llm
  question: "MANDATORY FIRST LINES (write these two lines first, before any analysis; copy exactly):\nVERDICT=TRUE_POSITIVE|FALSE_POSITIVE|INDETERMINATE\nCITATIONS=path:line(-line), path:line(-line), ...\n\nAnalyze test coverage and untested API exposure using ONLY the evidence.\n\n1) Coverage metrics:\n   - Percentage of files that have tests\n   - Whether testing appears well-distributed (brief justification)\n\n2) Exposure risk (untested public APIs):\n   - Top 5 untested files by public API surface / exposure score (from evidence)\n   - Total exposure score (from evidence)\n\n3) Recommendations:\n   - Prioritize untested files by exposure risk for test-writing recommendations (top 3).\n\nRules:\n- CITATIONS must be a single comma-separated line (no bullets, no backticks, no annotations).\n- Prefer real file:line tokens; if only CITE= tokens exist, cite those verbatim.\n"
  preflight:
  - name: test_coverage
    cmd:
    - test-coverage
    - --format
    - json
  - name: coverage_risk
    cmd:
    - coverage-risk
    - --format
    - json
  expected_verdict: TRUE_POSITIVE
- id: R_TEST_2
  title: Integration Test Directories
  category: testing
  top_k: 10
  advice_mode: llm
  question: 'Identify integration test directories and files (heuristic):

    - any files under `tests/`

    - any crate-specific `crates/*/tests/`

    Provide file path list and describe test intent from nearby names.

    '
  preflight:
  - name: tests_dir_hits
    cmd:
    - search
    - /tests/
    - --limit
    - '120'
    - --format
    - json
  - name: mod_tests_hits
    cmd:
    - search
    - mod tests
    - --limit
    - '120'
    - --format
    - json
  expected_verdict: TRUE_POSITIVE
- id: R_CARGO_1
  title: Workspace Members and Editions
  category: cargo
  top_k: 8
  advice_mode: llm
  question: 'Summarize workspace composition:

    - list workspace members (if present)

    - list crate editions encountered (2021/2024/2018)

    Use evidence from Cargo.toml files only.

    '
  preflight:
  - name: workspace_blocks
    cmd:
    - query
    - --file
    - Cargo.toml
    - --contains
    - '[workspace]'
    - --include-all-files
    - --columns
    - file_path
    - line_start
    - line_end
    - source_text
    - --limit
    - '80'
    - --format
    - json
  - name: edition_hits
    cmd:
    - search
    - edition = "
    - --include-all-files
    - --limit
    - '80'
    - --format
    - json
  expected_verdict: TRUE_POSITIVE
- id: R_CARGO_2
  title: Feature Definitions and Feature Usage
  category: cargo
  top_k: 12
  advice_mode: llm
  question: 'Inventory Cargo features:

    A) crate-defined [features] blocks (may be none)

    B) dependency feature usage lines (features = [...], default-features = false)

    Quote feature blocks/lines; do not invent.

    '
  preflight:
  - name: features_blocks
    cmd:
    - query
    - --file
    - Cargo.toml
    - --contains
    - '[features]'
    - --include-all-files
    - --columns
    - file_path
    - line_start
    - line_end
    - source_text
    - --limit
    - '200'
    - --format
    - json
    render: block
    fence_lang: toml
    block_max_chars: 8000
  - name: dep_features_hits
    cmd:
    - search
    - features = [
    - --include-all-files
    - --limit
    - '200'
    - --format
    - json
  - name: default_features_hits
    cmd:
    - search
    - default-features
    - --include-all-files
    - --limit
    - '200'
    - --format
    - json
  expected_verdict: TRUE_POSITIVE
- id: R_CARGO_3
  title: Build Scripts and Proc-macro Risk
  category: cargo
  top_k: 10
  advice_mode: llm
  question: 'Detect build-time risk surface:

    - presence of build.rs files (build scripts)

    - proc-macro crates (proc-macro = true in Cargo.toml)

    - procedural macro usage indicators (proc_macro, TokenStream)

    Summarize supply-chain risk and mitigation recommendations.

    '
  preflight:
  - name: build_rs_query
    cmd:
    - query
    - --file
    - build.rs
    - --include-all-files
    - --columns
    - file_path
    - source_text
    - --limit
    - '50'
    - --format
    - json
  - name: proc_macro_flag
    cmd:
    - query
    - --file
    - Cargo.toml
    - --contains
    - proc-macro = true
    - --include-all-files
    - --columns
    - file_path
    - line_start
    - line_end
    - source_text
    - --limit
    - '50'
    - --format
    - json
  - name: proc_macro_code_hits
    cmd:
    - search
    - proc_macro
    - --limit
    - '80'
    - --format
    - json
  - name: tokenstream_hits
    cmd:
    - search
    - TokenStream
    - --limit
    - '80'
    - --format
    - json
  expected_verdict: TRUE_POSITIVE
- id: R_DOC_COVERAGE_1
  title: Doc Coverage Summary (Bounded Structured)
  category: documentation
  top_k: 10
  advice_mode: llm
  question: "Analyze documentation coverage using ONLY the structured evidence below.\n\nBOUND: The evidence is truncated (max_items). Compute metrics ONLY over the entities shown in evidence (do NOT claim repo-global totals).\nUse DOC_SUMMARY counts; do not claim repo-global totals beyond DOC_SUMMARY.\n\nReport:\n1) Coverage stats over shown entities:\n   - For visibility=pub: count with docs vs without docs\n   - Overall (all shown entities): count with docs vs without docs\n2) Top 3 actionable recommendations (pub-first priority).\n\nEven if you think evidence is insufficient, you MUST still output VERDICT and CITATIONS per pack schema.\n"
  preflight:
  - name: doc_analysis
    cmd:
    - docs
    - --format
    - json
    transform:
      render: list
      max_items: 50
      max_chars: 16000
  expected_verdict: TRUE_POSITIVE
- id: R_DOC_UNDOC_1
  title: Undocumented Public API Examples (Bounded)
  category: documentation
  top_k: 10
  advice_mode: llm
  question: 'MANDATORY FIRST LINES (write these two lines first, before any list; copy exactly):

    VERDICT=TRUE_POSITIVE|FALSE_POSITIVE|INDETERMINATE

    CITATIONS=path:line(-line), path:line(-line), ...


    Task: List up to 10 undocumented public items (visibility=pub) from the structured evidence.

    Use DOC_SUMMARY counts; do not claim repo-global totals beyond DOC_SUMMARY.


    Output format (exact; ONE line per item; keep each line short):

    1. <signature-or-name> — <path:line> — undocumented (doc.has_doc=false)


    Rules:

    - Max 10 items. If fewer exist, list all shown.

    - Do NOT add prose paragraphs. No sub-bullets.

    - Always include at least one <path:line> per item (from evidence).

    - Even if you think evidence is insufficient, still output VERDICT and CITATIONS (first lines already written).

    '
  preflight:
  - name: doc_analysis
    cmd:
    - docs
    - --format
    - json
    transform:
      render: list
      max_items: 50
      max_chars: 16000
  expected_verdict: TRUE_POSITIVE
- id: R_DOC_MATCH_1
  title: Doc↔Code Semantic Alignment
  category: documentation
  top_k: 12
  advice_mode: llm
  question: "Verify that documentation comments accurately describe the function/struct signatures.\nThe evidence is a numbered list. Each line has the format:\n  N. file:line-range | sig: <signature> | doc: <documentation text> | +entity_id=...\n\nThe \"sig:\" field is the actual Rust code signature. The \"doc:\" field is the /// documentation comment attached to it.\nYOUR TASK: For the first 15 items: 1. Read the sig: field (this IS the code) 2. Read the doc: field (this IS the documentation) 3. Compare: Does the doc accurately describe what the signature declares? 4. Rate each: ACCURATE / PARTIAL / MISLEADING\nOutput format: | File:Line | Signature | Doc Summary | Rating | |-----------|-----------|-------------|--------| | file:line | signature text | brief doc summary | ACCURATE/PARTIAL/MISLEADING |\nIMPORTANT: All required data IS in the evidence above. The sig: and doc: fields are already extracted for you. Do NOT say \"NOT FOUND\" - read the numbered list items.\n"
  preflight:
  - name: doc_entities
    cmd:
    - docs
    - --format
    - json
    transform:
      filter_fn: compact_docs
      render: list
      max_items: 30
      max_chars: 10000
  expected_verdict: TRUE_POSITIVE
validation:
  required_verdicts:
  - TRUE_POSITIVE
  - FALSE_POSITIVE
  - INDETERMINATE
  citation_format: path:line(-line)
  fail_on_missing_citations: true
  minimum_questions: 21
  enforce_citations_from_evidence: true
  enforce_no_new_paths: true
  enforce_paths_must_be_cited: true
runner:
  plugin: rsqt_guru
  plugin_config:
    rules_path: cfg_rust_audit_rsqt_general_finding_rules.yaml
    question_validators_path: cfg_rust_audit_rsqt_general_question_validators.yaml
