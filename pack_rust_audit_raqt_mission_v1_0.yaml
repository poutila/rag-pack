version: 1.0.2
pack_type: rust_audit_raqt_mission
engine: raqt
response_schema: |-
  MANDATORY FIRST LINES (must be first two lines):
  VERDICT=TRUE_POSITIVE|FALSE_POSITIVE|INDETERMINATE
  CITATIONS=repo/path.rs:line(-line), repo/path.rs:line(-line), ...

  Policy:
  - If a claim cannot be proven from extracted evidence, set VERDICT=INDETERMINATE.
  - Prefer deterministic extraction evidence; do not speculate.
  - Do not add markdown section headers.
defaults:
  chat_top_k: 12
  max_tokens: 2500
  temperature: 0.0
questions:
- id: R_BOUNDARY_1
  title: Cross-Crate Error Propagation Analysis
  category: error_handling
  top_k: 15
  answer_mode: llm
  advice_mode: llm
  question: |-
    Assess cross-crate error propagation using only evidence.

    Required output lines:
    ENGINE_TO_CLI_FROM=YES|NO|INSUFFICIENT
    ENGINE_TO_GUI_FROM=YES|NO|INSUFFICIENT
    MISSING_BOUNDARIES=<comma-separated boundary labels or NONE>
    FROM_IMPL_1=...
    FROM_IMPL_2=...
    USAGE_1=path:line | short note
    USAGE_2=path:line | short note

    Rules:
    - Enumerate impl From<...> entries individually.
    - Explicitly answer engine->cli and engine->gui boundaries.
    - Cite every claim.
  chat:
    retry_on_schema_fail: true
    schema_retry_attempts: 2
    strict_response_template: |-
      VERDICT=TRUE_POSITIVE|FALSE_POSITIVE|INDETERMINATE
      CITATIONS=<comma-separated evidence tokens from CITE= lines only>
      ENGINE_TO_CLI_FROM=YES|NO|INSUFFICIENT
      ENGINE_TO_GUI_FROM=YES|NO|INSUFFICIENT
      MISSING_BOUNDARIES=<comma-separated labels or NONE>
      FROM_IMPL_1=<impl signature or NONE>
      FROM_IMPL_2=<impl signature or NONE>
      USAGE_1=<path:line | short note or NONE>
      USAGE_2=<path:line | short note or NONE>
  preflight:
  - name: raqt_error_variants
    cmd: [defs, --kind, enum, --name, Error, --format, json]
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      max_items: 30
      max_chars: 3000
  - name: raqt_trait_impls
    cmd: [defs, --kind, object, --name, 'impl From<', --format, json]
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      max_items: 40
      max_chars: 4200
  - name: raqt_cross_refs
    cmd: [refs, --format, json]
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      require_regex:
      - (?i)main
      - (?i)run_cli
      max_items: 25
      max_chars: 3200
  - name: from_impls
    engine_override: rsqt
    cmd: [search, 'impl From<', --limit, '60', --format, json]
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      exclude_test_files: true
      exclude_comments: true
      max_items: 40
      max_chars: 4200
  - name: error_type_defs
    engine_override: rsqt
    cmd: [search, 'enum Error', --limit, '40', --format, json]
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      exclude_test_files: true
      exclude_comments: true
      max_items: 30
      max_chars: 3200
  - name: boundary_usage
    engine_override: rsqt
    cmd: [search, '.map_err(', --limit, '160', --format, json]
    render: lines
    block_max_chars: 6000
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      exclude_test_files: true
      exclude_comments: true
      require_regex:
      - (?i)(CommandError|CliError|Error)
      max_items: 35
  expected_verdict: TRUE_POSITIVE

- id: R_PORTS_1
  title: Dependency Injection Port Coverage
  category: architecture
  top_k: 15
  answer_mode: llm
  advice_mode: llm
  question: |-
    Assess dependency-injection port coverage using only evidence.

    Required output lines:
    RATING=FULLY_TESTABLE|MOSTLY_TESTABLE|GAPS_EXIST

    For each production trait, enumerate:
    - trait declaration
    - impl entries
    - REAL/FAKE/TEST classification
    - counts per trait
    - Arc<T> blanket status if present
  chat:
    retry_on_schema_fail: true
    schema_retry_attempts: 2
    strict_response_template: |-
      VERDICT=TRUE_POSITIVE|FALSE_POSITIVE|INDETERMINATE
      CITATIONS=<comma-separated evidence tokens from CITE= lines only>
      RATING=FULLY_TESTABLE|MOSTLY_TESTABLE|GAPS_EXIST
      PORT_TRAIT_1=<trait name @ path:line | CLASS=PRODUCTION_PORT or NONE>
      PORT_TRAIT_2=<trait name @ path:line | CLASS=PRODUCTION_PORT or NONE>
      TRAIT_IMPL_1=<trait name | CLASS=REAL|FAKE|TEST | path:line or NONE>
      TRAIT_IMPL_2=<trait name | CLASS=REAL|FAKE|TEST | path:line or NONE>
      COVERAGE_GAPS=<comma-separated gaps or NONE>
  preflight:
  - name: raqt_traits
    cmd: [defs, --kind, interface, --limit, '120', --format, json]
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      exclude_test_files: true
  - name: raqt_trait_impls
    cmd: [defs, --kind, object, --limit, '300', --format, json]
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      exclude_test_files: true
  - name: trait_search
    engine_override: rsqt
    cmd: [search, 'pub trait ', --limit, '60', --format, json]
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      exclude_test_files: true
      exclude_comments: true
  - name: dyn_usage
    engine_override: rsqt
    cmd: [search, 'Box<dyn ', --limit, '60', --format, json]
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      exclude_test_files: true
      exclude_comments: true
  expected_verdict: TRUE_POSITIVE

- id: R_TRAIT_1
  title: Trait Implementation Completeness
  category: architecture
  top_k: 15
  answer_mode: llm
  advice_mode: llm
  question: |-
    Assess trait implementation completeness using only evidence.

    Required output lines:
    RATING=COMPLETE|MOSTLY_COMPLETE|GAPS_EXIST
    DEBUG_COVERAGE=<N>/<M>
    DISPLAY_IMPL_INVENTORY=<comma-separated signatures or NONE>
    ERROR_DISPLAY_GAPS=<comma-separated type names or NONE>
    CONFIG_DEFAULT_GAPS=<comma-separated type names or NONE>

    Rules:
    - Enumerate relevant Debug/Display/Default/Serialize/Deserialize evidence.
    - Name each missing type explicitly.
    - Return plain text only.
    - Output VERDICT first and CITATIONS second, then emit each required key exactly once.
    - Use NONE for unknown/empty inventories.
  chat:
    retry_on_schema_fail: true
    schema_retry_attempts: 1
    strict_response_template: |-
      VERDICT=TRUE_POSITIVE|FALSE_POSITIVE|INDETERMINATE
      CITATIONS=<path:line(-line), path:line(-line), ...>
      RATING=COMPLETE|MOSTLY_COMPLETE|GAPS_EXIST
      DEBUG_COVERAGE=<integer>/<integer>
      DISPLAY_IMPL_INVENTORY=<signature_1, signature_2, ... or NONE>
      ERROR_DISPLAY_GAPS=<TypeA, TypeB, ... or NONE>
      CONFIG_DEFAULT_GAPS=<TypeA, TypeB, ... or NONE>
  preflight:
  - name: raqt_all_impls
    cmd: [defs, --kind, object, --limit, '450', --format, json]
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      exclude_test_files: true
      max_items: 140
      max_chars: 7000
  - name: raqt_all_structs
    cmd: [defs, --kind, struct, --limit, '300', --format, json]
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      exclude_test_files: true
  - name: raqt_all_enums
    cmd: [defs, --kind, enum, --limit, '220', --format, json]
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      exclude_test_files: true
  - name: derive_search
    engine_override: rsqt
    cmd: [search, '#[derive(', --limit, '120', --format, json]
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      exclude_test_files: true
      exclude_comments: true
      max_items: 140
      max_chars: 7000
  - name: display_impls
    engine_override: rsqt
    cmd: [search, 'impl std::fmt::Display for ', --limit, '120', --format, json]
    render: lines
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      exclude_test_files: true
      exclude_comments: true
      max_items: 60
  - name: default_impls
    engine_override: rsqt
    cmd: [search, 'impl Default for ', --limit, '120', --format, json]
    render: lines
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      exclude_test_files: true
      exclude_comments: true
      max_items: 60
  - name: debug_impls
    engine_override: rsqt
    cmd: [search, 'impl std::fmt::Debug for ', --limit, '120', --format, json]
    render: lines
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      exclude_test_files: true
      exclude_comments: true
      max_items: 60
  expected_verdict: TRUE_POSITIVE

- id: R_MISSION_RUNTIME_1
  title: RAQT Runtime and Contract Readiness
  category: tooling
  top_k: 10
  answer_mode: llm
  advice_mode: llm
  question: |-
    You are validating whether RAQT runtime behavior is suitable for safety-critical refactor planning.

    Required output lines (exactly once each):
    TRUST_GATE_DOC=YES|NO|INSUFFICIENT
    DOCTOR_STATUS=PASS|WARN|FAIL|INSUFFICIENT
    STRICT_JSON_MODE=OK|BROKEN|INSUFFICIENT
    PROFILE_CI_MODE=ACCEPTED|REJECTED|INSUFFICIENT
    FAIL_ON_STALE_FLAG=ACCEPTED|REJECTED|INSUFFICIENT
    KIND_ALIAS_FN_FUNCTION=YES|NO|INSUFFICIENT
    SCHEMA_COLUMNS=<integer or INSUFFICIENT>
    STAT_NUM_ROWS=<integer or INSUFFICIENT>

    Then add short bullet list:
    - RUNTIME_BLOCKER_1=...
    - RUNTIME_BLOCKER_2=... (optional)
  chat:
    retry_on_schema_fail: true
    schema_retry_attempts: 2
    strict_response_template: |-
      VERDICT=TRUE_POSITIVE|FALSE_POSITIVE|INDETERMINATE
      CITATIONS=<comma-separated evidence tokens from CITE= lines only>
      TRUST_GATE_DOC=YES|NO|INSUFFICIENT
      DOCTOR_STATUS=PASS|WARN|FAIL|INSUFFICIENT
      STRICT_JSON_MODE=OK|BROKEN|INSUFFICIENT
      PROFILE_CI_MODE=ACCEPTED|REJECTED|INSUFFICIENT
      FAIL_ON_STALE_FLAG=ACCEPTED|REJECTED|INSUFFICIENT
      KIND_ALIAS_FN_FUNCTION=YES|NO|INSUFFICIENT
      SCHEMA_COLUMNS=<integer or INSUFFICIENT>
      STAT_NUM_ROWS=<integer or INSUFFICIENT>
      RUNTIME_BLOCKER_1=<short blocker or NONE>
      RUNTIME_BLOCKER_2=<short blocker or NONE>
  preflight:
  - name: raqt_cli_reference
    cmd: [cli-reference, --date, '2026-02-11']
    render: lines
    block_max_chars: 7000
  - name: raqt_generate_help
    cmd: [generate, --help]
    render: lines
    block_max_chars: 5000
  - name: raqt_doctor_json
    cmd: [doctor, --format, json]
  - name: raqt_kinds_json
    cmd: [kinds, --format, json]
  - name: raqt_stats_json
    cmd: [stats, --format, json]
  - name: raqt_schema_json
    cmd: [schema, --format, json]
  - name: raqt_strict_json_stats
    cmd: [--strict-json, stats, --format, json]
    render: lines
    block_max_chars: 5000
  - name: raqt_profile_ci_doctor
    cmd: [--profile, ci, doctor, --format, json]
  - name: raqt_fail_on_stale_stats
    cmd: [--fail-on-stale, stats, --format, json]
  expected_verdict: TRUE_POSITIVE

- id: R_MISSION_CALLGRAPH_1
  title: Callgraph and Coupling Hotspots
  category: architecture
  top_k: 12
  answer_mode: llm
  advice_mode: llm
  question: |-
    Build a coupling map for refactor planning using callgraph and refs evidence.

    Required output lines:
    EDGE_ROWS=<integer or INSUFFICIENT>
    SELF_EDGES_PRESENT=YES|NO|UNKNOWN
    TOP_CALLERS=<comma-separated symbol/path items or NONE>
    TOP_CALLEES=<comma-separated symbol/path items or NONE>
    REFACTOR_BOUNDARY_CANDIDATES=<comma-separated module/path items or NONE>

    Rules:
    - Prefer non-test production paths.
    - Cite each top caller/callee claim.
    - Return plain text only.
    - Output VERDICT first and CITATIONS second, then emit each required key exactly once.
  chat:
    retry_on_schema_fail: true
    schema_retry_attempts: 2
    strict_response_template: |-
      VERDICT=TRUE_POSITIVE|FALSE_POSITIVE|INDETERMINATE
      CITATIONS=<comma-separated evidence tokens from CITE= lines only>
      EDGE_ROWS=<integer or INSUFFICIENT>
      SELF_EDGES_PRESENT=YES|NO|UNKNOWN
      TOP_CALLERS=<comma-separated symbol/path items or NONE>
      TOP_CALLEES=<comma-separated symbol/path items or NONE>
      REFACTOR_BOUNDARY_CANDIDATES=<comma-separated module/path items or NONE>
  preflight:
  - name: mission_defs_functions
    cmd: [defs, --kind, function, --limit, '650', --format, json]
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      exclude_test_files: true
      max_items: 200
      max_chars: 9000
  - name: mission_refs_all
    cmd: [refs, --limit, '900', --format, json]
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      exclude_test_files: true
      max_items: 240
      max_chars: 9000
  - name: mission_callgraph_all
    cmd: [callgraph, --limit, '900', --format, json]
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      exclude_test_files: true
      max_items: 240
      max_chars: 9000
  - name: mission_callgraph_self
    cmd: [callgraph, --include-self, --limit, '900', --format, json]
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      exclude_test_files: true
      max_items: 240
      max_chars: 9000
  - name: mission_kinds_json
    cmd: [kinds, --format, json]
  expected_verdict: TRUE_POSITIVE

- id: R_MISSION_SAFETY_1
  title: Safety and Supply-Chain Exposure Surface
  category: safety
  top_k: 12
  answer_mode: llm
  advice_mode: llm
  question: |-
    Build a safety exposure inventory focused on panic/unwrap/unsafe/ffi/build tooling risks.

    Required output lines:
    UNSAFE_SURFACE=NONE|LOW|MEDIUM|HIGH|INSUFFICIENT
    FFI_SURFACE=NONE|LOW|MEDIUM|HIGH|INSUFFICIENT
    PROD_PANIC_SURFACE=NONE|LOW|MEDIUM|HIGH|INSUFFICIENT
    PROD_UNWRAP_SURFACE=NONE|LOW|MEDIUM|HIGH|INSUFFICIENT
    SUPPLY_CHAIN_RISK=LOW|MEDIUM|HIGH|INSUFFICIENT
    SAFETY_GATE_1=...
    SAFETY_GATE_2=...
  chat:
    retry_on_schema_fail: true
    schema_retry_attempts: 2
    strict_response_template: |-
      VERDICT=TRUE_POSITIVE|FALSE_POSITIVE|INDETERMINATE
      CITATIONS=<comma-separated evidence tokens from CITE= lines only>
      UNSAFE_SURFACE=NONE|LOW|MEDIUM|HIGH|INSUFFICIENT
      FFI_SURFACE=NONE|LOW|MEDIUM|HIGH|INSUFFICIENT
      PROD_PANIC_SURFACE=NONE|LOW|MEDIUM|HIGH|INSUFFICIENT
      PROD_UNWRAP_SURFACE=NONE|LOW|MEDIUM|HIGH|INSUFFICIENT
      SUPPLY_CHAIN_RISK=LOW|MEDIUM|HIGH|INSUFFICIENT
      SAFETY_GATE_1=<short gate or INSUFFICIENT>
      SAFETY_GATE_2=<short gate or INSUFFICIENT>
  preflight:
  - name: unsafe_inventory
    engine_override: rsqt
    cmd: [search, 'unsafe', --limit, '200', --format, json]
    render: lines
    block_max_chars: 7000
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      exclude_test_files: true
      exclude_comments: true
      max_items: 80
  - name: ffi_inventory
    engine_override: rsqt
    cmd: [search, 'extern "C"', --limit, '120', --format, json]
    render: lines
    block_max_chars: 7000
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      exclude_test_files: true
      exclude_comments: true
      max_items: 80
  - name: prod_unwrap_inventory
    engine_override: rsqt
    cmd: [search, '.unwrap(', --limit, '220', --format, json]
    render: lines
    block_max_chars: 7000
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      exclude_test_files: true
      exclude_comments: true
      max_items: 80
  - name: panic_inventory
    engine_override: rsqt
    cmd: [search, 'panic!(', --limit, '200', --format, json]
    render: lines
    block_max_chars: 7000
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      exclude_test_files: true
      exclude_comments: true
      max_items: 80
  - name: build_rs_inventory
    engine_override: rsqt
    cmd: [search, 'build.rs', --limit, '80', --format, json]
    render: lines
    block_max_chars: 5000
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      - '(^|/)build\.rs$'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      exclude_test_files: true
      exclude_comments: true
      max_items: 40
  - name: proc_macro_inventory
    engine_override: rsqt
    cmd: [search, 'proc-macro = true', --limit, '80', --format, json]
    render: lines
    block_max_chars: 5000
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      - '(^|/)Cargo\.toml$'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      exclude_test_files: true
      exclude_comments: true
      max_items: 40
  expected_verdict: TRUE_POSITIVE

- id: R_MISSION_RAG_1
  title: RAG Retrieval and Chat Grounding Reliability
  category: rag
  top_k: 12
  answer_mode: llm
  advice_mode: llm
  question: |-
    Evaluate retrieval reliability for refactor planning.

    Required output lines:
    RAG_INDEX_EXECUTED=YES|NO|INSUFFICIENT
    RAG_SEARCH_RESULT_COUNT=<integer or INSUFFICIENT>
    CHAT_STUB_EXECUTED=YES|NO|INSUFFICIENT
    PROMPT_PROFILE_GROUNDED_SUPPORTED=YES|NO|INSUFFICIENT
    TOP_REFACTOR_SEAMS=<comma-separated seam candidates or NONE>

    Rules:
    - Use only evidence from rag-index/rag-search/chat outputs.
    - Cite seam candidates with path:line tokens.
    - Return plain text only.
    - Output VERDICT first and CITATIONS second, then emit each required key exactly once.
  chat:
    retry_on_schema_fail: true
    schema_retry_attempts: 2
    strict_response_template: |-
      VERDICT=TRUE_POSITIVE|FALSE_POSITIVE|INDETERMINATE
      CITATIONS=<comma-separated evidence tokens from CITE= lines only>
      RAG_INDEX_EXECUTED=YES|NO|INSUFFICIENT
      RAG_SEARCH_RESULT_COUNT=<integer or INSUFFICIENT>
      CHAT_STUB_EXECUTED=YES|NO|INSUFFICIENT
      PROMPT_PROFILE_GROUNDED_SUPPORTED=YES|NO|INSUFFICIENT
      TOP_REFACTOR_SEAMS=<comma-separated seam candidates or NONE>
  preflight:
  - name: rag_index_help
    cmd: [rag-index, --help]
    render: lines
    block_max_chars: 6000
  - name: rag_index_build
    cmd: [rag-index, '{parquet}', --output, '{index}', --chunk-strategy, defs-with-refs, --include-refs]
    render: lines
    block_max_chars: 6000
  - name: rag_search_mission_json
    cmd: [rag-search, 'error boundary conversion', --top-k, '8', --format, json]
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      exclude_test_files: true
      max_items: 20
      max_chars: 7000
  - name: rag_search_mission_text
    cmd: [rag-search, 'trait implementation completeness', --top-k, '5', --format, json]
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      exclude_test_files: true
      max_items: 12
      max_chars: 5000
  - name: chat_help
    cmd: [chat, --help]
    render: lines
    block_max_chars: 7000
  - name: chat_stub_json
    cmd: [chat, 'List likely refactor seams for safety-critical Rust code', --backend, stub, --top-k, '6', --prompt-profile, grounded, --format, json]
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      exclude_test_files: true
      max_items: 20
      max_chars: 7000
  expected_verdict: TRUE_POSITIVE

- id: R_MISSION_REFACTOR_PLAN_1
  title: Mission-Grade Refactor Plan (Lunar Orbiter Constraints)
  category: planning
  top_k: 14
  answer_mode: llm
  advice_mode: llm
  question: |-
    Produce a refactor plan suitable for software that will run in a manned lunar orbiter.
    Assume strict reliability, observability, and fail-closed requirements.

    Required output lines:
    PLAN_READINESS=READY|NEEDS_MORE_EVIDENCE
    PHASE_1_ACTIONS=<comma-separated actions>
    PHASE_2_ACTIONS=<comma-separated actions>
    PHASE_3_ACTIONS=<comma-separated actions>
    BLOCKERS=<comma-separated blockers or NONE>
    SAFETY_GATES=<comma-separated gates>
    COVERAGE_GAPS=<comma-separated gaps or NONE>

    Rules:
    - Prioritize changes that reduce catastrophic failure risk first.
    - Avoid speculative claims not grounded in evidence.
    - Return plain text only.
    - Output VERDICT first and CITATIONS second, then emit each required key exactly once.
    - Use NONE for empty blocker/gap fields.
  chat:
    retry_on_schema_fail: true
    schema_retry_attempts: 1
    strict_response_template: |-
      VERDICT=TRUE_POSITIVE|FALSE_POSITIVE|INDETERMINATE
      CITATIONS=<path:line(-line), path:line(-line), ...>
      PLAN_READINESS=READY|NEEDS_MORE_EVIDENCE
      PHASE_1_ACTIONS=<action_1, action_2, ...>
      PHASE_2_ACTIONS=<action_1, action_2, ...>
      PHASE_3_ACTIONS=<action_1, action_2, ...>
      BLOCKERS=<blocker_1, blocker_2, ... or NONE>
      SAFETY_GATES=<gate_1, gate_2, ...>
      COVERAGE_GAPS=<gap_1, gap_2, ... or NONE>
  preflight:
  - name: plan_doctor_json
    cmd: [doctor, --format, json]
  - name: plan_stats_json
    cmd: [stats, --format, json]
  - name: plan_schema_json
    cmd: [schema, --format, json]
  - name: plan_kinds_json
    cmd: [kinds, --format, json]
  - name: plan_defs_struct_json
    cmd: [defs, --kind, struct, --limit, '320', --format, json]
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      exclude_test_files: true
      max_items: 120
      max_chars: 7000
  - name: plan_defs_function_json
    cmd: [defs, --kind, function, --limit, '700', --format, json]
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      exclude_test_files: true
      max_items: 140
      max_chars: 7000
  - name: plan_callgraph_json
    cmd: [callgraph, --limit, '950', --format, json]
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      exclude_test_files: true
      max_items: 200
      max_chars: 9000
  - name: plan_rag_search_json
    cmd: [rag-search, 'error handling and dependency injection', --top-k, '10', --format, json]
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      exclude_test_files: true
      max_items: 24
      max_chars: 8000
  - name: plan_chat_stub_json
    cmd: [chat, 'What are the highest risk refactor seams?', --backend, stub, --top-k, '8', --prompt-profile, grounded, --format, json]
    transform:
      include_path_regex:
      - '(^|/)crates/'
      - '(^|/)src/'
      exclude_path_regex:
      - '(^|/)audit_runs(/|$)'
      exclude_test_files: true
      max_items: 24
      max_chars: 8000
  expected_verdict: TRUE_POSITIVE

validation:
  required_verdicts:
  - TRUE_POSITIVE
  - FALSE_POSITIVE
  - INDETERMINATE
  citation_format: path:line(-line)
  fail_on_missing_citations: true
  enforce_citations_from_evidence: true
  enforce_no_new_paths: true
  enforce_paths_must_be_cited: true
  minimum_questions: 8
runner:
  plugin: rsqt_guru
  plugin_config:
    rules_path: cfg_rust_audit_raqt_mission_finding_rules.yaml
    question_validators_path: cfg_rust_audit_raqt_mission_question_validators.yaml
